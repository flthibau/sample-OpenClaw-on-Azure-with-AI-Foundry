#cloud-config
# =============================================================
# OpenClaw on Azure - FULLY AUTOMATED Cloud-Init
# Version 2.0 - Zero manual configuration required
# =============================================================

package_update: true
package_upgrade: true

packages:
  - apt-transport-https
  - ca-certificates
  - curl
  - gnupg
  - lsb-release
  - jq

runcmd:
  # === DOCKER INSTALLATION ===
  - mkdir -p /etc/apt/keyrings
  - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
  - echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
  - apt-get update
  - apt-get install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin
  - systemctl enable docker
  - systemctl start docker
  
  # === GET VM USERNAME ===
  - export VMUSER=$(getent passwd 1000 | cut -d: -f1)
  - usermod -aG docker $VMUSER
  
  # === CREATE OPENCLAW DIRECTORY ===
  - mkdir -p /home/$VMUSER/openclaw/data
  - chown -R $VMUSER:$VMUSER /home/$VMUSER/openclaw
  
  # === GET AZURE METADATA ===
  - export AZURE_ENDPOINT="${AZURE_OPENAI_ENDPOINT:-https://ai-openclaw-dev.openai.azure.com/}"
  - export AZURE_DEPLOYMENT="${AZURE_OPENAI_DEPLOYMENT:-gpt-4o-deployment}"
  
  # === CREATE DOCKER COMPOSE FILE ===
  - |
    cat > /home/$VMUSER/openclaw/docker-compose.yml << 'COMPOSE_EOF'
    version: '3.8'
    services:
      openclaw:
        image: fourplayers/openclaw:latest
        container_name: openclaw
        restart: unless-stopped
        environment:
          - OPENCLAW_GATEWAY_HOST=0.0.0.0
          - OPENCLAW_GATEWAY_PORT=18789
          - OPENCLAW_GATEWAY_PASSWORD=${GATEWAY_PASSWORD}
          - OPENCLAW_TLS_ENABLED=false
          - AZURE_OPENAI_ENDPOINT=${AZURE_ENDPOINT}
          - AZURE_OPENAI_DEPLOYMENT=${AZURE_DEPLOYMENT}
          - AZURE_OPENAI_API_VERSION=2024-10-01-preview
        volumes:
          - ./data:/home/node/.openclaw:rw
        ports:
          - "18789:18789"
        cap_add:
          - SYS_ADMIN
        security_opt:
          - seccomp=unconfined
        shm_size: '2gb'
        healthcheck:
          test: ["CMD", "wget", "-q", "--spider", "http://localhost:18789/health"]
          interval: 30s
          timeout: 10s
          retries: 3
          start_period: 120s
    COMPOSE_EOF
  
  # === CREATE .ENV FILE ===
  - |
    GATEWAY_PASSWORD=$(openssl rand -base64 16 | tr -dc 'a-zA-Z0-9' | head -c 16)
    cat > /home/$VMUSER/openclaw/.env << EOF
    GATEWAY_PASSWORD=${GATEWAY_PASSWORD}!
    AZURE_ENDPOINT=https://ai-openclaw-dev.openai.azure.com/
    AZURE_DEPLOYMENT=gpt-4o-deployment
    EOF
    echo "${GATEWAY_PASSWORD}!" > /home/$VMUSER/openclaw/gateway-password.txt
  
  # === FIX PERMISSIONS ===
  - chown -R $VMUSER:$VMUSER /home/$VMUSER/openclaw
  
  # === PULL AND START OPENCLAW ===
  - cd /home/$VMUSER/openclaw && docker compose pull
  - cd /home/$VMUSER/openclaw && docker compose up -d
  
  # === CREATE HELPER SCRIPTS ===
  - |
    cat > /home/$VMUSER/openclaw/start.sh << 'SCRIPT_EOF'
    #!/bin/bash
    cd ~/openclaw
    docker compose up -d
    echo "âœ… OpenClaw started!"
    docker compose ps
    SCRIPT_EOF
    chmod +x /home/$VMUSER/openclaw/start.sh
  
  - |
    cat > /home/$VMUSER/openclaw/stop.sh << 'SCRIPT_EOF'
    #!/bin/bash
    cd ~/openclaw
    docker compose down
    echo "â¹ï¸ OpenClaw stopped"
    SCRIPT_EOF
    chmod +x /home/$VMUSER/openclaw/stop.sh
  
  - |
    cat > /home/$VMUSER/openclaw/logs.sh << 'SCRIPT_EOF'
    #!/bin/bash
    cd ~/openclaw
    docker compose logs -f --tail 100
    SCRIPT_EOF
    chmod +x /home/$VMUSER/openclaw/logs.sh
  
  - |
    cat > /home/$VMUSER/openclaw/status.sh << 'SCRIPT_EOF'
    #!/bin/bash
    echo "ğŸ¦ OpenClaw Status"
    echo "=================="
    docker compose -f ~/openclaw/docker-compose.yml ps
    echo ""
    echo "ğŸ”‘ Gateway Password:"
    cat ~/openclaw/gateway-password.txt
    echo ""
    echo "ğŸŒ Access URL: http://$(curl -s ifconfig.me):18789"
    SCRIPT_EOF
    chmod +x /home/$VMUSER/openclaw/status.sh
  
  # === SET MOTD ===
  - |
    cat > /etc/motd << 'MOTD_EOF'

    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘                  ğŸ¦ OpenClaw on Azure ğŸ¦                       â•‘
    â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
    â•‘                                                               â•‘
    â•‘  âœ… OpenClaw is running automatically!                        â•‘
    â•‘                                                               â•‘
    â•‘  Commands:                                                    â•‘
    â•‘    ./status.sh  - Show status & password                      â•‘
    â•‘    ./logs.sh    - View logs                                   â•‘
    â•‘    ./stop.sh    - Stop OpenClaw                               â•‘
    â•‘    ./start.sh   - Start OpenClaw                              â•‘
    â•‘                                                               â•‘
    â•‘  Access: http://<PUBLIC-IP>:18789                             â•‘
    â•‘                                                               â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    MOTD_EOF
  
  - chown -R $VMUSER:$VMUSER /home/$VMUSER/openclaw

final_message: "OpenClaw deployment complete after $UPTIME seconds"
