#cloud-config
# =============================================================
# OpenClaw on Azure - FULLY AUTOMATED Cloud-Init
# Version 2.0 - Zero manual configuration required
# =============================================================

package_update: true
package_upgrade: true

packages:
  - apt-transport-https
  - ca-certificates
  - curl
  - gnupg
  - lsb-release
  - jq

runcmd:
  # === NODE.JS INSTALLATION ===
  - curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
  - apt-get install -y nodejs
  - npm install -g pnpm
  
  # === GET VM USERNAME ===
  - export VMUSER=$(getent passwd 1000 | cut -d: -f1)
  
  # === INSTALL AZURE CLI ===
  - curl -sL https://aka.ms/InstallAzureCLIDeb | bash
  
  # === CREATE OPENCLAW DIRECTORY ===
  - mkdir -p /home/$VMUSER/openclaw/data
  - chown -R $VMUSER:$VMUSER /home/$VMUSER/openclaw
  
  # === GET AZURE METADATA ===
  - export AZURE_ENDPOINT="${AZURE_OPENAI_ENDPOINT:-https://ai-openclaw-dev.openai.azure.com/}"
  - export AZURE_DEPLOYMENT="${AZURE_OPENAI_DEPLOYMENT:-gpt-4o-deployment}"
  
  # === CREATE .ENV FILE ===
  - |
    GATEWAY_PASSWORD=$(openssl rand -base64 16 | tr -dc 'a-zA-Z0-9' | head -c 16)
    cat > /home/$VMUSER/openclaw/.env << EOF
    GATEWAY_PASSWORD=${GATEWAY_PASSWORD}!
    AZURE_ENDPOINT=https://ai-openclaw-dev.openai.azure.com/
    AZURE_DEPLOYMENT=gpt-4o-deployment
    PORT=18789
    EOF
    echo "${GATEWAY_PASSWORD}!" > /home/$VMUSER/openclaw/gateway-password.txt
  
  # === CLONE AND INSTALL OPENCLAW ===
  - git clone https://github.com/openclaw/openclaw.git /home/$VMUSER/openclaw/app 2>/dev/null || true
  - cd /home/$VMUSER/openclaw/app && pnpm install 2>/dev/null || npm install 2>/dev/null || true
  
  # === FIX PERMISSIONS ===
  - chown -R $VMUSER:$VMUSER /home/$VMUSER/openclaw
  
  # === CREATE SYSTEMD SERVICE ===
  - |
    cat > /etc/systemd/system/openclaw.service << 'SVCEOF'
    [Unit]
    Description=OpenClaw Gateway Service
    After=network.target

    [Service]
    Type=simple
    User=$VMUSER
    WorkingDirectory=/home/$VMUSER/openclaw/app
    EnvironmentFile=/home/$VMUSER/openclaw/.env
    ExecStart=/usr/bin/npx openclaw gateway start
    Restart=on-failure
    RestartSec=10

    [Install]
    WantedBy=multi-user.target
    SVCEOF
  - systemctl daemon-reload
  - systemctl enable openclaw
  - systemctl start openclaw
  
  # === CREATE HELPER SCRIPTS ===
  - |
    cat > /home/$VMUSER/openclaw/start.sh << 'SCRIPT_EOF'
    #!/bin/bash
    cd ~/openclaw
    sudo systemctl start openclaw
    echo "âœ… OpenClaw started!"
    systemctl status openclaw --no-pager
    SCRIPT_EOF
    chmod +x /home/$VMUSER/openclaw/start.sh
  
  - |
    cat > /home/$VMUSER/openclaw/stop.sh << 'SCRIPT_EOF'
    #!/bin/bash
    cd ~/openclaw
    sudo systemctl stop openclaw
    echo "â¹ï¸ OpenClaw stopped"
    SCRIPT_EOF
    chmod +x /home/$VMUSER/openclaw/stop.sh
  
  - |
    cat > /home/$VMUSER/openclaw/logs.sh << 'SCRIPT_EOF'
    #!/bin/bash
    journalctl -u openclaw -f --no-pager -n 100
    SCRIPT_EOF
    chmod +x /home/$VMUSER/openclaw/logs.sh
  
  - |
    cat > /home/$VMUSER/openclaw/status.sh << 'SCRIPT_EOF'
    #!/bin/bash
    echo "ğŸ¦ OpenClaw Status"
    echo "=================="
    systemctl status openclaw --no-pager
    echo ""
    echo "ğŸ”‘ Gateway Password:"
    cat ~/openclaw/gateway-password.txt
    echo ""
    echo "ğŸŒ Access URL: http://$(curl -s ifconfig.me):18789"
    SCRIPT_EOF
    chmod +x /home/$VMUSER/openclaw/status.sh
  
  # === SET MOTD ===
  - |
    cat > /etc/motd << 'MOTD_EOF'

    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘                  ğŸ¦ OpenClaw on Azure ğŸ¦                       â•‘
    â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
    â•‘                                                               â•‘
    â•‘  âœ… OpenClaw is running automatically!                        â•‘
    â•‘                                                               â•‘
    â•‘  Commands:                                                    â•‘
    â•‘    ./status.sh  - Show status & password                      â•‘
    â•‘    ./logs.sh    - View logs                                   â•‘
    â•‘    ./stop.sh    - Stop OpenClaw                               â•‘
    â•‘    ./start.sh   - Start OpenClaw                              â•‘
    â•‘                                                               â•‘
    â•‘  Access: http://<PUBLIC-IP>:18789                             â•‘
    â•‘                                                               â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    MOTD_EOF
  
  - chown -R $VMUSER:$VMUSER /home/$VMUSER/openclaw

final_message: "OpenClaw deployment complete after $UPTIME seconds"
