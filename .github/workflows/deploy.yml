name: Deploy OpenClaw on Azure

on:
  push:
    branches: [ main ]
    paths:
      - 'infra/**'
      - '.github/workflows/deploy.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'infra/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod
      location:
        description: 'Azure region'
        required: true
        default: 'eastus2'
        type: string
      vmSize:
        description: 'VM Size'
        required: true
        default: 'Standard_D2s_v5'
        type: string

permissions:
  id-token: write
  contents: read

env:
  AZURE_RESOURCE_GROUP: rg-openclaw-${{ github.event.inputs.environment || 'dev' }}
  AZURE_LOCATION: ${{ github.event.inputs.location || 'eastus2' }}
  TEMPLATE_FILE: infra/main.bicep
  PARAMETERS_FILE: infra/main.bicepparam

jobs:
  validate:
    name: Validate Bicep
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Validate Bicep template
        uses: azure/arm-deploy@v2
        with:
          resourceGroupName: ${{ env.AZURE_RESOURCE_GROUP }}
          template: ${{ env.TEMPLATE_FILE }}
          parameters: >
            location=${{ env.AZURE_LOCATION }}
            baseName=openclaw
            environment=${{ github.event.inputs.environment || 'dev' }}
            vmAdminUsername=azureuser
            vmAdminPassword=${{ secrets.VM_ADMIN_PASSWORD }}
            vmSize=${{ github.event.inputs.vmSize || 'Standard_D2s_v5' }}
          deploymentMode: Validate
          failOnStdErr: true

      - name: Run Bicep Linter
        run: |
          az bicep build --file ${{ env.TEMPLATE_FILE }} --stdout > /dev/null
          echo "âœ… Bicep linting passed"

  what-if:
    name: What-If Analysis
    runs-on: ubuntu-latest
    needs: validate
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Create Resource Group (if needed)
        run: |
          az group create \
            --name ${{ env.AZURE_RESOURCE_GROUP }} \
            --location ${{ env.AZURE_LOCATION }} \
            --output none || true

      - name: What-If Analysis
        uses: azure/arm-deploy@v2
        with:
          resourceGroupName: ${{ env.AZURE_RESOURCE_GROUP }}
          template: ${{ env.TEMPLATE_FILE }}
          parameters: >
            location=${{ env.AZURE_LOCATION }}
            baseName=openclaw
            environment=${{ github.event.inputs.environment || 'dev' }}
            vmAdminUsername=azureuser
            vmAdminPassword=${{ secrets.VM_ADMIN_PASSWORD }}
            vmSize=${{ github.event.inputs.vmSize || 'Standard_D2s_v5' }}
          additionalArguments: --what-if
          failOnStdErr: false

  deploy:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    needs: validate
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    environment: 
      name: ${{ github.event.inputs.environment || 'dev' }}
    outputs:
      vmName: ${{ steps.deploy.outputs.vmName }}
      vmPrivateIp: ${{ steps.deploy.outputs.vmPrivateIp }}
      bastionName: ${{ steps.deploy.outputs.bastionName }}
      managedIdentityClientId: ${{ steps.deploy.outputs.managedIdentityClientId }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Create Resource Group
        run: |
          az group create \
            --name ${{ env.AZURE_RESOURCE_GROUP }} \
            --location ${{ env.AZURE_LOCATION }} \
            --tags \
              project=openclaw \
              environment=${{ github.event.inputs.environment || 'dev' }} \
              managedBy=github-actions

      - name: Deploy Bicep template
        id: deploy
        uses: azure/arm-deploy@v2
        with:
          resourceGroupName: ${{ env.AZURE_RESOURCE_GROUP }}
          template: ${{ env.TEMPLATE_FILE }}
          parameters: >
            location=${{ env.AZURE_LOCATION }}
            baseName=openclaw
            environment=${{ github.event.inputs.environment || 'dev' }}
            vmAdminUsername=azureuser
            vmAdminPassword=${{ secrets.VM_ADMIN_PASSWORD }}
            vmSize=${{ github.event.inputs.vmSize || 'Standard_D2s_v5' }}
          deploymentName: openclaw-${{ github.run_number }}
          failOnStdErr: true

      - name: Output deployment results
        run: |
          echo "## Deployment Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Resource | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| VM Name | ${{ steps.deploy.outputs.vmName }} |" >> $GITHUB_STEP_SUMMARY
          echo "| VM Private IP | ${{ steps.deploy.outputs.vmPrivateIp }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Bastion Name | ${{ steps.deploy.outputs.bastionName }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Managed Identity Client ID | ${{ steps.deploy.outputs.managedIdentityClientId }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Connect to VM via Azure Bastion" >> $GITHUB_STEP_SUMMARY
          echo "2. Run \`setup-azure-ai.sh\` to configure AI Foundry" >> $GITHUB_STEP_SUMMARY
          echo "3. Start OpenClaw with \`start.sh\`" >> $GITHUB_STEP_SUMMARY

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Checkov
        uses: bridgecrewio/checkov-action@v12
        with:
          file: ${{ env.TEMPLATE_FILE }}
          framework: bicep
          output_format: sarif
          output_file_path: results.sarif
          soft_fail: true

      - name: Upload SARIF file
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: results.sarif

  notify:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [validate, deploy]
    if: failure()
    steps:
      - name: Create Issue on Failure
        uses: actions/github-script@v7
        with:
          script: |
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Deployment Failed - Run #${context.runNumber}`,
              body: `## Deployment Failure
              
              **Workflow Run:** [#${context.runNumber}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
              **Branch:** ${context.ref}
              **Triggered by:** ${context.actor}
              **Time:** ${new Date().toISOString()}
              
              Please investigate the failure and take corrective action.`,
              labels: ['bug', 'deployment']
            });
            console.log(`Created issue #${issue.data.number}`);
